#!/bin/bash

echo "=== –°–ö–ê–ß–ò–í–ê–ù–ò–ï PLATFORM 8.3.27.1559 ==="

# –ó–∞–ø—Ä–æ—Å –ª–æ–≥–∏–Ω–∞
read -p "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω: " USERNAME
read -s -p "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å: " PASSWORD
echo

COOKIE_JAR="/tmp/1c_cookies.txt"
OUTPUT_FILE="deb64_8_3_27_1559.zip"

# –û—á–∏—Å—Ç–∫–∞
rm -f $COOKIE_JAR form.html auth.html download_page.html $OUTPUT_FILE

echo "1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ –ø–æ—Ä—Ç–∞–ª–µ 1–°..."
curl -c $COOKIE_JAR \
     "https://login.1c.ru/login?service=https%3A%2F%2Freleases.1c.ru%2Fpublic%2Fsecurity_check" \
     --silent --output form.html

EXECUTION=$(grep -oP 'name="execution" value="\K[^"]+' form.html)

curl -L -c $COOKIE_JAR -b $COOKIE_JAR \
     --data-urlencode "username=$USERNAME" \
     --data-urlencode "password=$PASSWORD" \
     --data-urlencode "execution=$EXECUTION" \
     --data-urlencode "_eventId=submit" \
     --data-urlencode "geolocation=" \
     "https://login.1c.ru/login?service=https%3A%2F%2Freleases.1c.ru%2Fpublic%2Fsecurity_check" \
     --silent --output auth.html

if ! grep -q "–†–µ–ª–∏–∑—ã" auth.html; then
    echo "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
    exit 1
fi

echo "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞"

echo "2. –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–≥—Ä—É–∑–∫–∏..."
curl -b $COOKIE_JAR \
     "https://releases.1c.ru/version_file?nick=Platform83&ver=8.3.27.1559&path=Platform%5c8_3_27_1559%5cdeb64_8_3_27_1559.zip" \
     --silent --output download_page.html

# –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
DOWNLOAD_URLS=($(grep -oP 'https://dl[0-9]+\.1c\.ru/public/file/get/[a-f0-9-]+' download_page.html))

echo "3. –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª..."
for url in "${DOWNLOAD_URLS[@]}"; do
    echo "–ü—Ä–æ–±—É–µ–º: $(echo $url | cut -d'/' -f3)"
    
    curl -L -b $COOKIE_JAR \
         --progress-bar \
         --output $OUTPUT_FILE \
         "$url"
    
    if [ $? -eq 0 ] && [ -s "$OUTPUT_FILE" ]; then
        if file "$OUTPUT_FILE" | grep -q "Zip archive"; then
            echo "‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!"
            echo "üì¶ –ò–º—è: $OUTPUT_FILE"
            echo "üíæ –†–∞–∑–º–µ—Ä: $(du -h $OUTPUT_FILE | cut -f1)"
            break
        else
            echo "‚ùå –°–∫–∞—á–∞–ª—Å—è –Ω–µ ZIP —Ñ–∞–π–ª"
            rm -f "$OUTPUT_FILE"
        fi
    else
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è"
        rm -f "$OUTPUT_FILE"
    fi
done

if [ ! -f "$OUTPUT_FILE" ]; then
    echo "‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
    exit 1
fi

# –û—á–∏—Å—Ç–∫–∞
rm -f $COOKIE_JAR form.html auth.html download_page.html
USERNAME=""; PASSWORD=""

echo ""
echo "üéâ –ó–ê–í–ï–†–®–ï–ù–û! –§–∞–π–ª –≥–æ—Ç–æ–≤: $OUTPUT_FILE"
echo "üì¶ –†–∞–∑–º–µ—Ä: $(du -h $OUTPUT_FILE | cut -f1)"
